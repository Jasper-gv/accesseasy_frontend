name: Deploy AccessEasy App to AWS 

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-accesseasy:
    runs-on: ubuntu-latest
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout code 
        uses: actions/checkout@v4

      - name: Setup Node.js 
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.8'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build AccessEasy App
        run: |
          echo "ğŸ”¨ Building AccessEasy App..."
          echo "ğŸ“… Build time: $(date)"
          echo "ğŸ†” Commit: ${{ github.sha }}"
          npm run build
          echo "âœ… Build completed successfully!"
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_DIRECTUS_URL: ${{ secrets.VITE_DIRECTUS_URL }}
          VITE_API_TOKEN: ${{ secrets.VITE_API_TOKEN }}
          VITE_FIELDSEASY_DOMAIN: ${{ secrets.VITE_FIELDSEASY_DOMAIN }}
          # Add any additional environment variables your AccessEasy app needs

      - name: Verify build output
        run: |
          echo "ğŸ” Verifying build..."
          if [ ! -d "dist" ]; then
            echo "âŒ dist folder NOT found - build failed"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html NOT found - build failed"
            exit 1
          fi
          
          echo "âœ… Build verification passed"
          echo "ğŸ“ Build contents:"
          ls -la dist/
          echo "ğŸ“„ index.html preview:"
          head -5 dist/index.html

      - name: Deploy to S3
        run: |
          echo "ğŸš€ Deploying to S3..."
          echo "ğŸ“… Deploy time: $(date)"
          echo "ğŸ¯ Target: s3://accesseasy-production-assets/"
          
          # Deploy with explicit error handling
          if aws s3 sync dist/ s3://accesseasy-production-assets/ \
             --delete \
             --cache-control "no-cache,no-store,must-revalidate" \
             --metadata-directive REPLACE; then
            echo "âœ… S3 deployment successful!"
          else
            echo "âŒ S3 deployment failed!"
            exit 1
          fi

      - name: Verify S3 deployment
        run: |
          echo "ğŸ” Verifying S3 deployment..."
          
          # Check if files were uploaded
          if aws s3 ls s3://accesseasy-production-assets/index.html; then
            echo "âœ… index.html found in S3"
          else
            echo "âŒ index.html NOT found in S3"
            exit 1
          fi
          
          echo "ğŸ“‹ Recent files in S3:"
          aws s3 ls s3://accesseasy-production-assets/ --recursive | tail -5

      - name: Invalidate CloudFront cache 
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id E3RVSZPF5S9R11 \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          if [ ! -z "$INVALIDATION_ID" ]; then
            echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"
          else
            echo "âŒ CloudFront invalidation failed"
            exit 1
          fi

      - name: Final verification
        run: |
          echo "ğŸ§ª Final verification..."
          sleep 30
          
          # Test website response
          if curl -f -s https://d35etz9gpobn8g.cloudfront.net/ >/dev/null; then
            echo "âœ… Website is responding"
          else
            echo "âš ï¸ Website not responding yet (may need more time)"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ”— Live site: https://d35etz9gpobn8g.cloudfront.net"
          echo "ğŸŒ Custom domain: https://app1.accesseasy.in"
          echo "â° Wait 5-10 minutes for cache to fully clear"
