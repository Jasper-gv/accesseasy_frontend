import{_ as K,r as m,c as q,o as G,u as H,a as N,w as f,V as W,b as Y,d as Q,e as k,f as y,g as X,h as Z,i as t,n as ee,j as se,k as _,l as O,m as ae,p as P,q as C,s as M,t as A,v as oe,x as U,y as g}from"./index-B12n8wa1.js";import{_ as te}from"./project-CLF1wEVU.js";const le={class:"login-container"},ne={class:"card-content"},re={class:"tab-buttons-container"},ie={key:1,class:"form-section"},ue={class:"phone-row"},ce={key:2,class:"form-section"},me={class:"signup-text"},de={class:"footer-text"},ge={__name:"alternateLogin",setup(pe){const E=Y(),$=H(),p=m("phone"),h=m(""),n=m(""),b=m(!1),d=m(""),c=m(""),S=m(!1),x=m(!1),D=m(new Date().getFullYear()),L=q(()=>({backgroundImage:"url('/public/images/loginimage.png')",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",minHeight:"100vh"}));function R(r){p.value=r,n.value="",c.value=""}function B(){h.value=(h.value||"").replace(/\D/g,"").slice(0,10),n.value&&(n.value="")}function F(r){return/^\d{10}$/.test(r)}function j(r){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)}function w(){localStorage.removeItem("pinVerifiedInSession"),localStorage.removeItem("fromOtp"),localStorage.removeItem("sessionUuid"),localStorage.removeItem("userPhone"),localStorage.removeItem("fullPhoneNumber"),localStorage.removeItem("email"),localStorage.removeItem("emailSessionUuid"),localStorage.removeItem("userData"),localStorage.removeItem("tenantData")}function z(){x.value=!1}async function I(){var r,e,v,i;if(p.value==="phone"){n.value="";const l=(h.value||"").replace(/\D/g,"");if(!F(l)){n.value="Please enter a valid 10-digit mobile number.";return}b.value=!0;try{w();const o="+91"+l;if(!await g.checkPhoneExists(o)){n.value="This phone number is not registered. Please sign up first.";return}if(await g.checkUserResigned(o)){n.value="Resigned Employee has No access. Please contact your Company Admin.";return}const u=await g.getUserByPhone(o),V=u&&u.userPin,T=g.getToken()&&g.isAuthenticated();localStorage.setItem("userPhone",l),localStorage.setItem("fullPhoneNumber",o),localStorage.setItem("fromAlternateLogin","true"),!V||V&&!T?await J(o):V&&T&&E.push({name:"PinVerification",params:{phoneNumber:l}})}catch(o){console.error("Error during phone login:",o);let s="An error occurred. Please try again or check the internet connection";(e=(r=o.response)==null?void 0:r.data)!=null&&e.message?s=o.response.data.message:o.message&&(s=o.message),n.value=s}finally{b.value=!1}}else{if(c.value="",!j(d.value)){c.value="Enter a valid email address.";return}S.value=!0;try{if(w(),!await g.checkEmailExists(d.value)){c.value="This email is not registered. Please sign up first.";return}if(await g.checkUserResignedByEmail(d.value)){c.value="Resigned Employee has No access. Please contact your Company Admin.";return}const s=await fetch("https://appv1.fieldseasy.com/directus/emailLogin/generate-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:d.value,userApp:"fieldeasy"})}),a=await s.json().catch(()=>({}));if(!s.ok||!(a!=null&&a.otp_session_uuid)){const u=(a==null?void 0:a.message)||"Could not start email session. Try again.";throw new Error(u)}localStorage.setItem("email",d.value),localStorage.setItem("emailSessionUuid",a.otp_session_uuid),localStorage.setItem("fromAlternateLogin","true"),E.push({name:"EmailVerification",params:{email:d.value}})}catch(l){console.error("Error during email login:",l);let o="Something went wrong. Please try again.";(i=(v=l.response)==null?void 0:v.data)!=null&&i.message?o=l.response.data.message:l.message&&(o=l.message),c.value=o}finally{S.value=!1}}}async function J(r){var e,v,i,l,o;try{let s=await g.generateOtp(r);if(typeof s=="string")try{s=JSON.parse(s)}catch(a){console.error("Failed to parse response JSON:",a)}if(console.log("OTP Generation Response:",s),s&&s.otp_session_uuid)console.log("✅ Valid OTP response:",s),localStorage.setItem("sessionUuid",s.otp_session_uuid),localStorage.setItem("fromOtp","true"),E.push({name:"Verification",params:{phoneNumber:r.replace(countryCode.value,"")}});else{let a="Failed to generate OTP. Please try again.";s!=null&&s.message?a=s.message:(e=s==null?void 0:s.msg91Response)!=null&&e.message&&(a=`${s.message||"OTP Error:"} ${s.msg91Response.message}`),n.value=a}}catch(s){console.error("Error generating OTP:",s);let a="Failed to generate OTP. Please try again.";if(s.message==="RESIGNED_USER")a="Resigned Employee has No access. Please contact your Company Admin.";else if((i=(v=s.response)==null?void 0:v.data)!=null&&i.message)a=s.response.data.message;else if((l=s.response)!=null&&l.data){const u=s.response.data;u.message?a=u.message:(o=u.msg91Response)!=null&&o.message&&(a=`${u.message||"OTP Error:"} ${u.msg91Response.message}`)}else s.message&&(a=s.message);n.value=a}}return G(()=>{w(),$.query.timeout&&(x.value=!0)}),(r,e)=>{const v=Q("router-link");return k(),N(W,{fluid:"",class:"fill-height pa-0"},{default:f(()=>[y(X,{"no-gutters":"",class:"h-100"},{default:f(()=>[y(Z,{cols:"12",class:"d-flex align-center justify-end pa-0"},{default:f(()=>[t("div",{class:"background-container d-flex align-center justify-end h-100",style:ee(L.value)},[t("div",le,[y(se,{class:"login-card",style:{border:"2px solid #059669","border-radius":"16px",overflow:"hidden","box-shadow":"0 10px 30px rgba(0, 0, 0, 0.15)"}},{default:f(()=>[e[12]||(e[12]=t("div",{class:"card-header"},[t("div",{class:"logo-section"},[t("img",{src:te,alt:"FieldsEasy",class:"logo-image"})])],-1)),e[13]||(e[13]=t("div",{class:"card-subheader"},[t("h2",{class:"subheader-title"},"Switch Account")],-1)),t("div",ne,[x.value?(k(),N(ae,{key:0,type:"error",variant:"tonal",class:"mb-4",density:"compact",closable:"","onClick:close":z},{default:f(()=>e[4]||(e[4]=[P(" Session timed out ")])),_:1})):_("",!0),t("div",re,[t("button",{onClick:e[0]||(e[0]=i=>R("phone")),class:C(["tab-btn",{active:p.value==="phone"}])}," PHONE ",2),t("button",{onClick:e[1]||(e[1]=i=>R("email")),class:C(["tab-btn",{active:p.value==="email"}])}," E-MAIL ",2)]),p.value==="phone"?(k(),O("div",ie,[e[6]||(e[6]=t("label",{class:"form-label"},"Mobile Number",-1)),t("div",ue,[e[5]||(e[5]=t("div",{class:"country-code-text"},"+91",-1)),y(M,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=i=>h.value=i),modelModifiers:{trim:!0},placeholder:"Enter your Phone Number",variant:"outlined",density:"comfortable",type:"tel",onInput:B,onKeyup:A(I,["enter"]),error:!!n.value,"error-messages":n.value?[n.value]:[],class:"phone-input"},null,8,["modelValue","error","error-messages"])]),e[7]||(e[7]=t("div",{class:"help-text"}," We'll initiate a secure session and take you to OTP verification. ",-1))])):_("",!0),p.value==="email"?(k(),O("div",ce,[e[8]||(e[8]=t("label",{class:"form-label"},"E-mail",-1)),y(M,{modelValue:d.value,"onUpdate:modelValue":e[3]||(e[3]=i=>d.value=i),modelModifiers:{trim:!0},placeholder:"your@example.com",type:"email",variant:"outlined",density:"comfortable",onKeyup:A(I,["enter"]),error:!!c.value,"error-messages":c.value?[c.value]:[]},null,8,["modelValue","error","error-messages"]),e[9]||(e[9]=t("div",{class:"help-text"}," We'll initiate a secure session and take you to OTP verification. ",-1))])):_("",!0),y(oe,{onClick:I,disabled:b.value||S.value,loading:b.value||S.value,block:"",size:"large",class:"submit-btn"},{default:f(()=>[P(U(b.value||S.value?"Loading...":(p.value==="phone","Sign In")),1)]),_:1},8,["disabled","loading"]),t("p",me,[e[11]||(e[11]=P(" Don't have an account? ")),y(v,{to:"/register",class:"signup-link"},{default:f(()=>e[10]||(e[10]=[P("Signup Now")])),_:1})])])]),_:1}),t("p",de,"© "+U(D.value)+" Fieldseasy",1)])],4)]),_:1})]),_:1})]),_:1})}}},he=K(ge,[["__scopeId","data-v-bad6b011"]]);export{he as default};
