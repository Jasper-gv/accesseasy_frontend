import{_ as De,r as d,K as R,c as L,L as Se,M as Ie,o as Le,E as Ce,l as _,k as F,i as o,f as C,N as Y,O as Ne,a as Ae,w as u,P as Ee,d as ee,q as k,y as ae,b as xe,e as h,S as Be,R as Fe,T as ze,ae as Oe,x as N,p as Te,B as Pe,W as je}from"./index-B12n8wa1.js";const Re={class:"leave-container"},qe={key:0,class:"filter-panel"},Ve={class:"filter-content"},He=["title"],Me={key:0,class:"filter-indicator"},Qe={key:0},Ke={key:1},We={key:2},Xe={key:3},Ze=["checked","disabled","onChange"],Ge={class:"profile-avatar"},Je=["src","alt"],Ye={key:1,class:"avatar-placeholder"},ea={class:"employee-info"},aa={class:"employee-name"},ta={key:0,class:"status-badge status-inactive ml-2"},sa={class:"leave-info-cell"},na={class:"taken-value"},la={__name:"leaveDetails",setup(ra){const z=d(!1),w=d(!0),m=d(""),O=d(!1);d(!1);const T=d({}),$=d(1),D=d(25),q=d(0),v=d([]),U=d([]),g=d([]),te=d(!1),se=R.getTenantId(),V=L(()=>{const e=[{key:"name",label:"Employee Name",sortable:!1,width:"150px"},{key:"employeeId",label:"Employee ID",sortable:!1,width:"120px"},{key:"organization",label:"Organization",sortable:!1,width:"130px"},{key:"department",label:"Department",sortable:!1,width:"130px"},{key:"attendanceCategory",label:"Attendance Category",sortable:!1,width:"120px"},{key:"dateOfLeaving",label:"Date of Leaving",sortable:!1,width:"120px"}];if(x.value.length>0){const a=x.value.map(r=>({key:r,label:r.split(/(?=[A-Z])/).map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "),sortable:!1,width:"180px"}));return[...e,...a]}else return[...e,{key:"leaveDetails",label:"Leave Details",sortable:!1,width:"200px"}]}),ne=L(()=>({organization:s.organization,department:s.department,branch:s.branch})),x=L(()=>{const e=new Set;return U.value.forEach(a=>{var r,c;(r=a.leaves)!=null&&r.leaveBalance&&Object.keys(a.leaves.leaveBalance).forEach(p=>e.add(p)),(c=a.leaves)!=null&&c.leaveTaken&&Object.keys(a.leaves.leaveTaken).forEach(p=>e.add(p.replace(/^t/,"")))}),Array.from(e)}),H=L(()=>s.employeeStatus.length>0||s.leaveType.length>0||s.organization||s.branch||s.department||s.role||s.gender||s.dateFrom||s.dateTo||m.value!==""),le=e=>{Object.assign(s,e),$.value=1,w.value=!0,b()};L(()=>U.value.length>0&&g.value.length===U.value.length),L(()=>g.value.length>0&&g.value.length<U.value.length);const re=e=>{w.value=e},P=L(()=>U.value),s=Se({employeeStatus:[],leaveType:[],organization:"",department:"",branch:"",role:"",gender:"",dateFrom:"",dateTo:""}),oe=[{key:"branch",label:"Branch",type:"select",show:!0},{key:"department",label:"Department",type:"select",show:!0}],y=e=>{var c;if(!((c=e.assignedUser)!=null&&c.dateOfLeaving))return!1;const a=new Date,r=new Date(e.assignedUser.dateOfLeaving);return a.setHours(0,0,0,0),r.setHours(0,0,0,0),r<=a},ie=xe(),b=async(e=$.value,a=D.value,r=m.value)=>{var c;try{z.value=!0;const p=ae.getToken(),A=await R.fetchLoginUserDetails(),f=R.getTenantId(),E=(c=A.role)==null?void 0:c.name,t=A.id;let n="https://appv1.fieldseasy.com/directus/items/personalModule",S=["assignedUser.id","assignedUser.first_name","assignedUser.tenant","assignedUser.dateOfLeaving","config.configName","config.id","assignedUser.avatar.id","assignedUser.avatar.type","assignedUser.avatar.title","department.id","department.departmentName","branch.id","branch.branchName","assignedUser.tenant.tenantId","assignedUser.organization.orgName","id","employeeId","leaves.id","leaves.leaveBalance","leaves.leaveTaken"],l=[];if(E==="Admin"||E==="Dealer"?(l.push(`filter[assignedUser][tenant][tenantId][_eq]=${f}`),s.organization&&l.push(`filter[assignedUser][organization][id][_eq]=${s.organization}`),s.department&&l.push(`filter[department][id][_eq]=${s.department}`),s.branch&&l.push(`filter[branchLocation][id][_eq]=${s.branch}`)):(l.push(`filter[_or][0][approver][id][_eq]=${t}`),l.push(`filter[_or][1][assignedUser][id][_eq]=${t}`)),r?(l.push(`filter[_or][0][employeeId][_icontains]=${r}`),l.push(`filter[_or][1][assignedUser][first_name][_icontains]=${r}`),l.push(`filter[_or][2][assignedUser][last_name][_icontains]=${r}`),l.push(`filter[_or][3][department][departmentName][_icontains]=${r}`),l.push(`filter[_or][4][branch][branchName][_icontains]=${r}`),l.push(`filter[_or][5][assignedUser][organization][orgName][_icontains]=${r}`)):(l.push(`limit=${a}`),l.push(`page=${e}`)),Array.isArray(v.value)&&v.value.length>0){const i=v.value.map(I=>`${I.order==="desc"?"-":""}${I.key}`).join(",");l.push(`sort=${i}`)}s.employeeStatus.length&&(s.employeeStatus.includes("Active")&&!s.employeeStatus.includes("Left")?l.push("filter[assignedUser][dateOfLeaving][_null]=true"):s.employeeStatus.includes("Left")&&!s.employeeStatus.includes("Active")&&l.push("filter[assignedUser][dateOfLeaving][_nnull]=true")),s.leaveType.length&&s.leaveType.forEach((i,I)=>{l.push(`filter[_or][${I+6}][leaves][leaveBalance][${i}][_gt]=0`)});let be=`${n}?${S.map(i=>`fields[]=${i}`).join("&")}&${l.join("&")}`;const ke=await(await fetch(be,{headers:{Authorization:`Bearer ${p}`}})).json();let Ue=await Promise.all(ke.data.map(async i=>{var I,j,Q,K,W,X,Z;if((I=i.assignedUser.avatar)!=null&&I.id){const B=`https://appv1.fieldseasy.com/directus/assets/${i.assignedUser.avatar.id}`;i.avatarImage=await ce(B)}return{...i,name:((j=i.assignedUser)==null?void 0:j.first_name)||"N/A",employeeId:i.employeeId||"-",organization:((K=(Q=i.assignedUser)==null?void 0:Q.organization)==null?void 0:K.orgName)||"N/A",department:((W=i.department)==null?void 0:W.departmentName)||"-",attendanceCategory:((X=i.config)==null?void 0:X.configName)||"-",dateOfLeaving:((Z=i.assignedUser)==null?void 0:Z.dateOfLeaving)||"-",...Object.fromEntries(x.value.map(B=>{var G,J;return[B,((J=(G=i.leaves)==null?void 0:G.leaveBalance)==null?void 0:J[B])||0]}))}}));U.value=Ue,console.log(U.value);let we=`${n}?${l.join("&")}&aggregate[countDistinct]=id`;const $e=await(await fetch(we,{headers:{Authorization:`Bearer ${p}`}})).json();q.value=parseInt($e.data[0].countDistinct.id)}catch(p){console.error("Error fetching leave details:",p)}finally{z.value=!1}},ce=async e=>{try{const a=ae.getToken(),r=await fetch(e,{headers:{Authorization:`Bearer ${a}`}});if(!r.ok)throw new Error("Failed to load image");const c=await r.blob();return URL.createObjectURL(c)}catch(a){return console.error("Error loading profile image:",a),null}},M=Ie.debounce(()=>{b(1,D.value,m.value)},300),de=e=>{var a;v.value=[{key:e,order:((a=v.value[0])==null?void 0:a.order)||"asc"}]},ue=e=>{var a;v.value=[{key:((a=v.value[0])==null?void 0:a.key)||"",order:e}]},ve=({field:e,direction:a})=>{v.value=[{key:e,order:a}],b()},ge=()=>{w.value=!w.value},pe=()=>{Object.keys(s).forEach(e=>{s[e]=Array.isArray(s[e])?[]:""}),m.value="",g.value=[],b()},fe=e=>{g.value.includes(e)?g.value=g.value.filter(a=>a!==e):g.value.push(e)},he=e=>{if(y(e)){console.log("Cannot navigate: Employee has left.");return}e&&e.id?(te.value=!0,ie.push({name:"EmployeeForm",params:{id:e.id,module:"leavePolicy"}})):console.error("Invalid item or item ID")},me=()=>{O.value=!1,b($.value,D.value)},ye=e=>{$.value=e,b(e,D.value,m.value)},_e=e=>{D.value=e,$.value=1,b(1,e,m.value)};return Le(async()=>{await b()}),Ce([m,v],()=>{M()},{deep:!0}),(e,a)=>{var p,A;const r=ee("ErrorState"),c=ee("LeaveForm");return h(),_("div",Re,[w.value?(h(),_("div",qe,[o("div",Ve,[C(Ne,{tenantId:Y(se),initialFilters:ne.value,initiallyVisible:!0,"filter-schema":oe,onApplyFilters:le,onFilterVisibilityChanged:re},null,8,["tenantId","initialFilters"])])])):F("",!0),o("div",{class:k(["main-content",{"full-width":!w.value}])},[C(Ee,{searchQuery:m.value,"onUpdate:searchQuery":[a[3]||(a[3]=f=>m.value=f),Y(M)],showSearch:!0,searchPlaceholder:"Search Leave Details",isEmpty:P.value.length===0&&!m.value,hasError:e.error},{"before-search":u(()=>[o("button",{class:k(["filter-toggle-static",{active:H.value}]),onClick:ge,title:w.value?"Hide filters":"Show filters","aria-label":"Toggle filters"},[a[5]||(a[5]=o("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[o("polygon",{points:"22,3 2,3 10,12.46 10,19 14,21 14,12.46"})],-1)),H.value?(h(),_("div",Me)):F("",!0)],10,He)]),pagination:u(()=>[C(je,{page:$.value,"onUpdate:page":[a[1]||(a[1]=f=>$.value=f),ye],itemsPerPage:D.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=f=>D.value=f),_e],"total-items":q.value},null,8,["page","itemsPerPage","total-items"])]),default:u(()=>{var f,E;return[z.value?(h(),_("div",Qe,[C(Be,{variant:"table-body-only",rows:U.value.length||10,columns:V.value.length},null,8,["rows","columns"])])):e.error?(h(),_("div",Ke,[C(r,{title:"Unable to load leave details",message:e.error,onRetry:b},null,8,["message"])])):P.value.length===0?(h(),_("div",We,[C(Fe,{title:"No employee leave Details found",message:"Try adjusting your filters or search term",primaryAction:{text:"Clear Filters",icon:e.X},onPrimaryAction:pe},null,8,["primaryAction"])])):(h(),_("div",Xe,[C(ze,{items:P.value,columns:V.value,selectedItems:g.value,showSelection:!1,sortBy:((f=v.value[0])==null?void 0:f.key)||"",sortDirection:((E=v.value[0])==null?void 0:E.order)||"asc",itemKey:"id",rowClickable:!0,"onUpdate:selectedItems":a[0]||(a[0]=t=>g.value=t),"onUpdate:sortBy":de,"onUpdate:sortDirection":ue,onRowClick:he,onSort:ve},Oe({"cell-checkbox":u(({item:t})=>[o("input",{type:"checkbox",class:"custom-checkbox",checked:g.value.includes(t.id),disabled:y(t),onChange:n=>fe(t.id)},null,40,Ze)]),"cell-profile":u(({item:t})=>{var n;return[o("div",Ge,[t.avatarImage?(h(),_("img",{key:0,src:t.avatarImage,alt:(n=t.assignedUser)==null?void 0:n.first_name,class:k(["avatar-image",{grayscale:y(t)}])},null,10,Je)):(h(),_("div",Ye,a[6]||(a[6]=[o("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[o("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),o("circle",{cx:"12",cy:"7",r:"4"})],-1)])))])]}),"cell-name":u(({item:t})=>{var n;return[o("div",ea,[o("h3",aa,[Te(N(((n=t.assignedUser)==null?void 0:n.first_name)||"N/A")+" ",1),y(t)?(h(),_("span",ta," LEFT ")):F("",!0)])])]}),"cell-employeeId":u(({item:t})=>[o("span",{class:k({"text-muted":y(t)})},N(t.employeeId||"-"),3)]),"cell-organization":u(({item:t})=>{var n,S;return[o("span",{class:k({"text-muted":y(t)})},N(((S=(n=t.assignedUser)==null?void 0:n.organization)==null?void 0:S.orgName)||"N/A"),3)]}),"cell-department":u(({item:t})=>{var n;return[o("span",{class:k({"text-muted":y(t)})},N(((n=t.department)==null?void 0:n.departmentName)||"-"),3)]}),"cell-attendanceCategory":u(({item:t})=>{var n;return[o("span",{class:k({"text-muted":y(t)})},N(((n=t.config)==null?void 0:n.configName)||"-"),3)]}),"cell-dateOfLeaving":u(({item:t})=>{var n;return[o("span",{class:k({"text-red":y(t)})},N(((n=t.assignedUser)==null?void 0:n.dateOfLeaving)||"-"),3)]}),_:2},[Pe(x.value,t=>({name:`cell-${t}`,fn:u(({item:n})=>{var S,l;return[o("div",sa,[o("div",{class:k(["leave-taken",{"text-muted":y(n)}])},[a[7]||(a[7]=o("span",{class:"taken-label"},"Taken:",-1)),o("span",na,N(((l=(S=n.leaves)==null?void 0:S.leaveTaken)==null?void 0:l[`t${t}`])||0),1)],2)])]})}))]),1032,["items","columns","selectedItems","sortBy","sortDirection"])]))]}),_:1},8,["searchQuery","isEmpty","hasError","onUpdate:searchQuery"]),O.value?(h(),Ae(c,{key:0,"personal-module-id":T.value.id,"config-name":(p=T.value.config)==null?void 0:p.configName,"first-name":(A=T.value.assignedUser)==null?void 0:A.first_name,onSaveSuccess:me,onCancel:a[4]||(a[4]=f=>O.value=!1)},null,8,["personal-module-id","config-name","first-name"])):F("",!0)],2)])}}},da=De(la,[["__scopeId","data-v-d84dec72"]]);export{da as default};
