import{_ as Ce,r as h,K as b,L as $e,c as E,af as xe,o as De,E as Be,l as g,k as J,i as n,f as D,N as ee,O as Ee,w as k,P as Fe,C as te,F as ae,B as se,q as L,y as F,b as Pe,e as m,S as ze,R as Le,T as je,p as j,x as _,W as qe,n as Ke}from"./index-B12n8wa1.js";const Oe={class:"attendance-container"},Je={key:0,class:"filter-panel"},Re={class:"filter-content"},Me=["title"],We={key:0,class:"filter-indicator"},Ve={key:0},He={key:1},Qe={key:2},Xe={class:"profile-avatar"},Ze=["src","alt"],Ge={key:1,class:"avatar-placeholder"},Ye={class:"employee-info"},et={class:"employee-name"},tt={class:"days-checkboxes"},at=["checked","onClick"],st={class:"dialog-header"},nt={class:"dialog-body"},it={class:"shift-details-list"},ot={class:"shift-header"},rt={class:"shift-details"},lt={class:"shift-time"},dt={class:"shift-break"},ct={__name:"attendanceDetails",setup(ut){const ne=Pe(),T=h(!1),R=h(!0),y=h(""),U=h([]),N=h(!0),P=h(!1),M=h([]),C=h([]),W=h("all"),V=h(["mon","tue","wed","thu","fri","sat","sun"]),w=h(1),B=h(25),q=h(0),v=h([]),A=h({}),ie=b.getTenantId(),H=h([]),Q=h([]),a=$e({shift:[],configName:[],employeeStatus:[],organization:"",department:"",branch:"",role:"",gender:"",dateFrom:"",dateTo:""});h([{text:"All",value:"all",color:"primary"},{text:"Working",value:"working",color:"primary"},{text:"Week Off",value:"weekoff",color:"error"}]);const $=[{key:"branch",label:"Branch",type:"select",show:!0},{key:"department",label:"Department",type:"select",show:!0}],X=[{key:"name",label:"Name",sortable:!1,width:"1.5"},{key:"department",label:"Department",sortable:!1,width:"1.5"},{key:"days",label:"Shifts Assigned Days",sortable:!1,width:"5"}],oe=E(()=>({shift:a.shift,configName:a.configName,employeeStatus:a.employeeStatus,organization:a.organization,department:a.department,role:a.role,gender:a.gender,dateFrom:a.dateFrom,dateTo:a.dateTo,branch:a.branch})),z=E(()=>a.shift.length>0||a.configName.length>0||a.employeeStatus.length>0||a.organization||a.department||a.branch||a.role||a.gender||a.dateFrom||a.dateTo||y.value!=="");E(()=>U.value.length>0&&C.value.length===U.value.length),E(()=>C.value.length>0&&C.value.length<U.value.length);const K=E(()=>U.value),Z={mon:{isKey:"isMonday",shiftKey:"monJ"},tue:{isKey:"isTuesday",shiftKey:"tueJ"},wed:{isKey:"isWednesday",shiftKey:"wedJ"},thu:{isKey:"isThursday",shiftKey:"thuJ"},fri:{isKey:"isFriday",shiftKey:"friJ"},sat:{isKey:"isSaturday",shiftKey:"satJ"},sun:{isKey:"isSunday",shiftKey:"sunJ"}},x=(t,e)=>{var s;try{const d=t.attendanceSettings||{},{isKey:o,shiftKey:r}=Z[e],i=d[o]||!1,p=((s=d[r])==null?void 0:s.shifts)||[];return{isWeekOff:i,shifts:p.map(f=>({shifts_id:A.value[f]||{id:f}}))}}catch(d){return console.error(`Error getting shifts for ${e}:`,d),{isWeekOff:!1,shifts:[]}}},G=t=>V.value.some(s=>!x(t,s).isWeekOff&&x(t,s).shifts.length>0)?"Assigned":"Not Assigned",re=t=>{const e=G(t);return{"status-badge":!0,"status-assigned":e==="Assigned","status-not-assigned":e==="Not Assigned"}},le=(t,e)=>{const{isWeekOff:s,shifts:d}=x(t,e);return{"day-checkbox-input":!0,"day-checkbox-assigned":!s&&d.length>0,"day-checkbox-not-assigned":s||d.length===0}},de=t=>{const e=JSON.parse(localStorage.getItem("shiftColors")||"{}");if(!e[t]){const s=Math.floor(Math.random()*360);e[t]=`hsl(${s}, 70%, 45%)`,localStorage.setItem("shiftColors",JSON.stringify(e))}return e[t]},O=t=>t?t.slice(0,5):"N/A",ce=async t=>{const e=F.getToken(),s=await b.getTenantId();if(!e||!s)return{};const d=100,o={},r=t.filter(i=>!A.value[i]);if(r.length===0)return A.value;try{for(let i=0;i<r.length;i+=d){const f=r.slice(i,i+d).join(","),c=await fetch(`https://appv1.fieldseasy.com/directus/items/shifts?filter[id][_in]=${f}&fields=id,shift,entryTime,exitTime,break&limit=${d}`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);(await c.json()).data.forEach(u=>{A.value[u.id]=u,o[u.id]=u})}return{...A.value,...o}}catch(i){return console.error("Error fetching shift details in batch:",i),A.value}},ue=t=>{const e=new Set;return t.forEach(s=>{["mon","tue","wed","thu","fri","sat","sun"].forEach(o=>{var f;const r=s.attendanceSettings||{},{shiftKey:i}=Z[o];(((f=r[i])==null?void 0:f.shifts)||[]).forEach(c=>e.add(c))})}),Array.from(e)},fe=async()=>{var e;const t=F.getToken();try{const s=await b.fetchLoginUserDetails(),d=b.getTenantId(),o=(e=s.role)==null?void 0:e.name,r=s.id;if(!t||!d)throw new Error("Authentication required or tenant not found");T.value=!0;const i=new URLSearchParams({fields:["id","employeeId","assignedUser.first_name","assignedUser.tenant","assignedUser.status","assignedUser.avatar.id","assignedUser.avatar.type","assignedUser.avatar.title","department.id","department.departmentName","branch.id","branch.branchName","config.configName","attendanceSettings.id","attendanceSettings.sunJ","attendanceSettings.monJ","attendanceSettings.tueJ","attendanceSettings.wedJ","attendanceSettings.thuJ","attendanceSettings.friJ","attendanceSettings.satJ","attendanceSettings.isMonday","attendanceSettings.isTuesday","attendanceSettings.isWednesday","attendanceSettings.isThursday","attendanceSettings.isFriday","attendanceSettings.isSaturday","attendanceSettings.isSunday"].join(","),limit:B.value,sort:v.value[0]?`${v.value[0].order==="desc"?"-":""}${v.value[0].key}`:"id",page:w.value});if(["Admin","Dealer"].includes(o)?i.append("filter[assignedUser][tenant][tenantId][_eq]",d):(i.append("filter[_or][0][approver][id][_eq]",r),i.append("filter[_or][1][assignedUser][id][_eq]",r)),y.value){const u=y.value;i.append("filter[_or][0][employeeId][_icontains]",u),i.append("filter[_or][1][assignedUser][first_name][_icontains]",u),i.append("filter[_or][2][department][departmentName][_icontains]",u),i.append("filter[_or][3][config][configName][_icontains]",u)}a.shift.length>0&&i.append("filter[attendanceSettings][shifts][shift][_in]",a.shift.join(",")),a.configName.length>0&&i.append("filter[config][configName][_in]",a.configName.join(",")),a.employeeStatus.length&&(a.employeeStatus.includes("Active")&&!a.employeeStatus.includes("Left")?i.append("filter[assignedUser][dateOfLeaving][_null]=true"):a.employeeStatus.includes("Left")&&!a.employeeStatus.includes("Active")&&i.append("filter[assignedUser][dateOfLeaving][_nnull]=true")),a.organization&&i.append("filter[assignedUser][organization][id][_eq]",a.organization),a.branch&&i.append("filter[branchLocation][id][_eq]",a.branch),a.department&&i.append("filter[department][id][_eq]=",a.department);const p=await fetch(`https://appv1.fieldseasy.com/directus/items/personalModule?${i}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const f=await p.json(),c=ue(f.data);c.length>0&&await ce(c);const l=await Promise.all(f.data.map(async u=>{var I,Y;if((Y=(I=u.assignedUser)==null?void 0:I.avatar)!=null&&Y.id){const Ue=`https://appv1.fieldseasy.com/directus/assets/${u.assignedUser.avatar.id}`;u.avatarImage=await ge(Ue)}return u}));U.value=l}catch(s){console.error("Error fetching attendance details:",s),U.value=[]}finally{R.value=!1,T.value=!1}},he=async()=>{var s,d,o,r;const t=F.getToken(),e=b.getTenantId();try{if(!t||!e)throw new Error("Authentication required or tenant not found");const i=await b.fetchLoginUserDetails(),p=(s=i.role)==null?void 0:s.name,f=i.id,c=new URLSearchParams;if(c.append("aggregate[count]","id"),["Admin","Dealer"].includes(p)?c.append("filter[assignedUser][tenant][tenantId][_eq]",e):p==="Manager"?(c.append("filter[_or][0][approver][id][_eq]",f),c.append("filter[_or][1][assignedUser][id][_eq]",f)):c.append("filter[assignedUser][id][_eq]",f),y.value){const I=y.value;c.append("filter[_or][0][employeeId][_icontains]",I),c.append("filter[_or][1][assignedUser][first_name][_icontains]",I),c.append("filter[_or][2][department][departmentName][_icontains]",I),c.append("filter[_or][3][config][configName][_icontains]",I)}a.shift.length>0&&c.append("filter[attendanceSettings][shifts][shift][_in]",a.shift.join(",")),a.configName.length>0&&c.append("filter[config][configName][_in]",a.configName.join(",")),a.employeeStatus.length&&(a.employeeStatus.includes("Active")&&!a.employeeStatus.includes("Left")?c.append("filter[assignedUser][dateOfLeaving][_null]=true"):a.employeeStatus.includes("Left")&&!a.employeeStatus.includes("Active")&&c.append("filter[assignedUser][dateOfLeaving][_nnull]=true")),a.organization&&c.append("filter[assignedUser][organization][orgName][_eq]",a.organization),a.department&&c.append("filter[department][departmentName][_eq]",a.department),a.branch&&c.append("filter[branchLocation][id][_eq]",a.branch);const l=await fetch(`https://appv1.fieldseasy.com/directus/items/personalModule?${c}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const u=await l.json();q.value=((r=(o=(d=u==null?void 0:u.data)==null?void 0:d[0])==null?void 0:o.count)==null?void 0:r.id)||0}catch(i){console.error("Error fetching aggregate count:",i),q.value=0}},pe=async()=>{const t=F.getToken(),e=await b.getTenantId();if(!(!t||!e))try{const[s,d,o,r]=await Promise.all([fetch(`https://appv1.fieldseasy.com/directus/items/shifts?fields=id,shift&filter[tenant][tenantId][_eq]=${e}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`https://appv1.fieldseasy.com/directus/items/personalModule?fields=config.configName&filter[assignedUser][tenant][tenantId][_eq]=${e}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`https://appv1.fieldseasy.com/directus/items/organization?fields=orgName&filter[tenant][tenantId][_eq]=${e}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`https://appv1.fieldseasy.com/directus/items/department?fields=departmentName&filter[tenant][tenantId][_eq]=${e}`,{headers:{Authorization:`Bearer ${t}`}})]),[i,p,f,c]=await Promise.all([s.json(),d.json(),o.json(),r.json()]);H.value=i.data.map(l=>({title:l.shift,value:l.shift})),Q.value=[...new Set(p.data.map(l=>{var u;return(u=l.config)==null?void 0:u.configName}).filter(Boolean))].map(l=>({title:l,value:l})),$.find(l=>l.key==="shift").options=H.value,$.find(l=>l.key==="configName").options=Q.value,$.find(l=>l.key==="organization").options=f.data.map(l=>({title:l.orgName,value:l.orgName})),$.find(l=>l.key==="department").options=c.data.map(l=>({title:l.departmentName,value:l.departmentName})),$.find(l=>l.key==="employeeStatus").options=[{title:"Active",value:"Active"},{title:"Left",value:"Left"}]}catch(s){console.error("Error fetching filter options:",s)}},ge=async t=>{try{const e=F.getToken(),s=await fetch(t,{headers:{Authorization:`Bearer ${e}`}});if(!s.ok)throw new Error("Failed to load image");const d=await s.blob();return URL.createObjectURL(d)}catch(e){return console.error("Error loading profile image:",e),null}},me=()=>{N.value=!N.value},ve=t=>{N.value=t},ye=t=>{Object.assign(a,t),w.value=1,N.value=!0,S()},ke=()=>{Object.keys(a).forEach(t=>{a[t]=Array.isArray(a[t])?[]:""}),y.value="",C.value=[],W.value="all",S()},_e=t=>{t!=null&&t.id&&ne.push(`/employee-details/employee/${t.id}/attendancemodule`)},we=async(t,e)=>{const{shifts:s}=t;s.length!==0&&(M.value=s.map(d=>({shifts_id:A.value[d.shifts_id.id]})),P.value=!0)},Se=t=>{var e;v.value=[{key:t,order:((e=v.value[0])==null?void 0:e.order)||"asc"}]},be=t=>{var e;v.value=[{key:((e=v.value[0])==null?void 0:e.key)||"",order:t}]},Ne=({field:t,direction:e})=>{v.value=[{key:t,order:e}],S()},Ae=t=>{w.value=t,S()},Ie=t=>{B.value=t,w.value=1,S()},Te=xe(()=>{w.value=1,S()},300),S=async()=>{T.value=!0,await he(),await fe(),T.value=!1};return De(async()=>{await b.fetchLoginUserDetails(),await S(),await pe()}),Be([y,()=>({...a}),W,v],()=>{w.value=1,S()},{deep:!0}),(t,e)=>(m(),g("div",Oe,[N.value?(m(),g("div",Je,[n("div",Re,[D(Ee,{tenantId:ee(ie),initialFilters:oe.value,initiallyVisible:!0,"filter-schema":$,onApplyFilters:ye,onFilterVisibilityChanged:ve},null,8,["tenantId","initialFilters"])])])):J("",!0),n("div",{class:L(["main-content",{"full-width":!N.value}])},[D(Fe,{searchQuery:y.value,"onUpdate:searchQuery":[e[3]||(e[3]=s=>y.value=s),ee(Te)],showSearch:!0,searchPlaceholder:"Search Employees...",isEmpty:K.value.length===0&&z.value&&!T.value,hasError:!1},{"before-search":k(()=>[n("button",{class:L(["filter-toggle-static",{active:z.value}]),onClick:me,title:N.value?"Hide filters":"Show filters","aria-label":"Toggle filters"},[e[7]||(e[7]=n("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("polygon",{points:"22,3 2,3 10,12.46 10,19 14,21 14,12.46"})],-1)),z.value?(m(),g("div",We)):J("",!0)],10,Me)]),pagination:k(()=>[D(qe,{page:w.value,"onUpdate:page":[e[1]||(e[1]=s=>w.value=s),Ae],itemsPerPage:B.value,"onUpdate:itemsPerPage":[e[2]||(e[2]=s=>B.value=s),Ie],"total-items":q.value},null,8,["page","itemsPerPage","total-items"])]),default:k(()=>{var s,d;return[T.value||R.value?(m(),g("div",Ve,[D(ze,{variant:"table-body-only",rows:B.value,columns:X.length},null,8,["rows","columns"])])):K.value.length===0&&z.value?(m(),g("div",He,[D(Le,{title:"No attendance records found",message:"Try adjusting your filters or search terms",primaryAction:{text:"Clear Filters",icon:t.X},onPrimaryAction:ke},null,8,["primaryAction"])])):(m(),g("div",Qe,[D(je,{items:K.value,columns:X,selectedItems:C.value,showSelection:!1,sortBy:((s=v.value[0])==null?void 0:s.key)||"",sortDirection:((d=v.value[0])==null?void 0:d.order)||"asc",itemKey:"id",rowClickable:!0,"onUpdate:selectedItems":e[0]||(e[0]=o=>C.value=o),"onUpdate:sortBy":Se,"onUpdate:sortDirection":be,onRowClick:_e,onSort:Ne},{"cell-profile":k(({item:o})=>{var r;return[n("div",Xe,[o.avatarImage?(m(),g("img",{key:0,src:o.avatarImage,alt:(r=o.assignedUser)==null?void 0:r.first_name,class:"avatar-image"},null,8,Ze)):(m(),g("div",Ge,e[8]||(e[8]=[n("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),n("circle",{cx:"12",cy:"7",r:"4"})],-1)])))])]}),"cell-name":k(({item:o})=>{var r;return[n("div",Ye,[n("h3",et,_(((r=o.assignedUser)==null?void 0:r.first_name)||"N/A"),1)])]}),"cell-department":k(({item:o})=>{var r;return[j(_(((r=o.department)==null?void 0:r.departmentName)||"No Department"),1)]}),"cell-attendancePolicy":k(({item:o})=>{var r;return[j(_(((r=o.config)==null?void 0:r.configName)||"N/A"),1)]}),"cell-status":k(({item:o})=>[n("span",{class:L(re(o))},_(G(o)),3)]),"cell-days":k(({item:o})=>[n("div",tt,[(m(!0),g(ae,null,se(V.value,r=>(m(),g("label",{key:r,class:"day-checkbox"},[n("input",{type:"checkbox",checked:!x(o,r).isWeekOff&&x(o,r).shifts.length>0,class:L(le(o,r)),disabled:"",onClick:te(i=>we(x(o,r),o),["stop"])},null,10,at),j(" "+_(r.charAt(0).toUpperCase()),1)]))),128))])]),_:1},8,["items","selectedItems","sortBy","sortDirection"])]))]}),_:1},8,["searchQuery","isEmpty","onUpdate:searchQuery"]),P.value?(m(),g("div",{key:0,class:"dialog-overlay",onClick:e[6]||(e[6]=s=>P.value=!1)},[n("div",{class:"dialog-content",onClick:e[5]||(e[5]=te(()=>{},["stop"]))},[n("div",st,[e[10]||(e[10]=n("div",{class:"dialog-title"},[n("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("circle",{cx:"12",cy:"12",r:"10"}),n("polyline",{points:"12,6 12,12 16,14"})]),n("h3",null,"Shift Details")],-1)),n("button",{class:"dialog-close",onClick:e[4]||(e[4]=s=>P.value=!1)},e[9]||(e[9]=[n("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),n("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]))]),n("div",nt,[n("div",it,[(m(!0),g(ae,null,se(M.value,(s,d)=>{var o,r,i,p,f;return m(),g("div",{key:d,class:"shift-detail-item"},[n("div",ot,[n("span",{class:"shift-name",style:Ke({backgroundColor:de(((o=s.shifts_id)==null?void 0:o.shift)||"default")})},[e[11]||(e[11]=n("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("circle",{cx:"12",cy:"12",r:"10"}),n("polyline",{points:"12,6 12,12 16,14"})],-1)),j(" "+_(((r=s.shifts_id)==null?void 0:r.shift)||"Unknown Shift"),1)],4)]),n("div",rt,[n("div",lt,[e[12]||(e[12]=n("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("circle",{cx:"12",cy:"12",r:"10"}),n("polyline",{points:"12,6 12,12 16,14"})],-1)),n("span",null,_(O((i=s.shifts_id)==null?void 0:i.entryTime))+" - "+_(O((p=s.shifts_id)==null?void 0:p.exitTime)),1)]),n("div",dt,[e[13]||(e[13]=n("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("circle",{cx:"12",cy:"12",r:"10"}),n("path",{d:"M8 12h8"})],-1)),n("span",null,"Break: "+_(O((f=s.shifts_id)==null?void 0:f.break)),1)])])])}),128))])])])])):J("",!0)],2)]))}},ht=Ce(ct,[["__scopeId","data-v-894f77ae"]]);export{ht as default};
